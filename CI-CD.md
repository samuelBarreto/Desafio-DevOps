# üöÄ CI/CD Pipeline - Desafio DevOps

Este projeto possui um pipeline completo de **Integra√ß√£o Cont√≠nua (CI)**, **Entrega Cont√≠nua (CD)** e **Release** usando GitHub Actions e Terraform.

## üìã Workflows Dispon√≠veis

### 1. **Backend CI Pipeline** (`.github/workflows/backend-ci.yml`)
**Trigger**: Push para `main`, `develop`, `feature/*` e `hotfix/*`
- üìè **Linting e Formata√ß√£o** com ESLint e Prettier
- ‚úÖ **Testes** com PostgreSQL e Jest
- üîí **SAST Scan** com Trivy (vulnerabilidades na imagem Docker)
- üõ°Ô∏è **DAST Scan** com script personalizado (testes de seguran√ßa da aplica√ß√£o)
- üê≥ **Build** da imagem Docker
- üì¶ **Push** para Docker Hub
- üì¢ **Notifica√ß√£o** de sucesso

### 2. **Terraform CI/CD Pipeline** (`.github/workflows/terraform.yml`)
**Trigger**: Push para `main`, `develop`, `feature/*` e `hotfix/*` (apenas mudan√ßas em `terraform/`)
- üîç **Valida√ß√£o** do c√≥digo Terraform
- üìù **Formata√ß√£o** e verifica√ß√£o de sintaxe
- üìã **Plan** da infraestrutura
- ‚ö° **Apply** autom√°tico (apenas na branch `main`)
- üõ°Ô∏è **Security Scan** com Trivy
- üß™ **Testes de Infraestrutura** p√≥s-deploy
- üìä **M√©tricas** e monitoramento

### 3. **Release Pipeline** (`.github/workflows/release.yml`)
**Trigger**: Manual via `workflow_dispatch`
- üîç **Valida√ß√£o** da vers√£o (arquivo `VERSION` ou input manual)
- üê≥ **Build e Push** da imagem Docker com nova vers√£o
- üñ•Ô∏è **Atualiza√ß√£o da VM** via SSH com `sed`
- üè∑Ô∏è **Cria√ß√£o** de Git Tag e GitHub Release
- üöÄ **Deploy autom√°tico** da nova vers√£o

### 4. **Deploy Pipeline** (`.github/workflows/deploy.yml`)
**Trigger**: Ap√≥s conclus√£o bem-sucedida dos pipelines de Backend CI e Terraform
- üîç **Valida√ß√£o** de ambos os workflows (Backend CI e Terraform)
- üîí **Lock mechanism** para evitar deploys simult√¢neos
- ‚è≥ **Aguardamento** de deploy anterior (se necess√°rio)
- üîç **Verifica√ß√£o** de pr√©-requisitos da infraestrutura
- üöÄ **Deploy** da aplica√ß√£o via SSH
- üß™ **Testes p√≥s-deploy** (health check, API, seguran√ßa)
- üìä **Monitoramento** e notifica√ß√µes

### 5. **Rollback Pipeline** (`.github/workflows/rollback.yml`)
**Trigger**: Manual via `workflow_dispatch`
- üîç **Valida√ß√£o** da vers√£o de rollback
- üîÑ **Rollback** da aplica√ß√£o para vers√£o anterior
- üß™ **Testes p√≥s-rollback** (health check, API)
- üì¢ **Notifica√ß√£o** de sucesso/falha

### 6. **Pull Request Check** (`.github/workflows/pr-check.yml`)
**Trigger**: Pull Requests para `main` e `develop`
- üìè **Linting e Formata√ß√£o** com ESLint e Prettier
- ‚úÖ **Testes** com PostgreSQL e Jest
- üîç **Valida√ß√£o** do c√≥digo Terraform
- üîí **SAST Scan** b√°sico

## üõ†Ô∏è Configura√ß√£o

### 1. **Secrets do GitHub**
Configure no seu reposit√≥rio (`Settings > Secrets and variables > Actions`):

```bash
# AWS Credentials (secrets)
AWS_ACCESS_KEY_ID=AKIA...
AWS_SECRET_ACCESS_KEY=...

# Docker Hub (vars e secrets)
DOCKERHUB_USERNAME=seu_usuario_dockerhub  # vars
DOCKERHUB_TOKEN=seu_token_dockerhub       # secrets

# SSH Key para VM (secrets)
SSH_PRIVATE_KEY=-----BEGIN OPENSSH PRIVATE KEY-----
sua_chave_privada_ssh_aqui
-----END OPENSSH PRIVATE KEY-----

# Terraform (secrets)
SSH_PUBLIC_KEY=ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC...
```

### 2. **Arquivo VERSION**
Controle de vers√£o centralizado:
```bash
# Atualizar vers√£o
echo "1.0.0" > VERSION
git add VERSION
git commit -m "üöÄ Bump version to 1.0.0"
git push origin main
```

### 3. **Infraestrutura AWS**
- **EC2 Instance**: Ubuntu para hospedar a aplica√ß√£o
- **VPC**: Rede virtual privada customizada
- **Security Groups**: Portas 22, 80, 443, 3000
- **Elastic IP**: IP din√¢mico
- **Key Pair**: SSH para acesso √† inst√¢ncia

## üöÄ Como Funciona o Fluxo Completo

### **1. Desenvolvimento**
```bash
# Fazer mudan√ßas no c√≥digo
git add .
git commit -m "feat: nova funcionalidade"
git push origin feature/nova-funcionalidade
```

### **2. CI Pipeline**
- ‚úÖ Testes executam automaticamente
- ‚úÖ SAST/DAST scans verificam seguran√ßa
- ‚úÖ Imagem Docker √© buildada e enviada para Docker Hub 

### **3. Merge para Main**
```bash
# Criar Pull Request
# Ap√≥s aprova√ß√£o, merge para main
```

### **4. Release**
```bash
# Op√ß√£o 1: Atualizar arquivo VERSION
echo "1.0.0" > VERSION
git add VERSION
git commit -m "üöÄ Bump version to 1.0.0"
git push origin main

# Op√ß√£o 2: Executar manualmente
# GitHub Actions ‚Üí Release Pipeline ‚Üí Run workflow ‚Üí 
# Preencher vers√£o ‚Üí Execute
```

### **5. Release Pipeline Executa**
- üîç Valida vers√£o (arquivo `VERSION` ou input manual)
- üê≥ Build imagem Docker com nova vers√£o
- üñ•Ô∏è Conecta na VM via SSH
- üìù Atualiza `docker-compose.prod.yml` com `sed`
- üöÄ Deploy da nova vers√£o
- üè∑Ô∏è Cria Git Tag e GitHub Release

### **6. Deploy Pipeline**
- üîç **Valida** se ambos os workflows (Backend CI e Terraform) terminaram com sucesso
- üîí **Verifica** se n√£o h√° deploy em andamento (lock mechanism)
- ‚è≥ **Aguarda** deploy anterior terminar (se necess√°rio)
- üîç Verifica se infraestrutura est√° pronta
- üöÄ Deploy da aplica√ß√£o
- üß™ Testes p√≥s-deploy
- üìä Monitoramento

### **7. Rollback Pipeline**
- üîç **Valida** vers√£o de rollback (formato e exist√™ncia no Docker Hub)
- üîí **Confirma** rollback manualmente ("YES")
- üîÑ **Executa** rollback para vers√£o anterior
- üß™ **Testa** aplica√ß√£o ap√≥s rollback
- üì¢ **Notifica** sucesso/falha

## üéØ Comandos √öteis

### **Release Manual**
```bash
# Op√ß√£o 1: Atualizar arquivo VERSION
echo "1.0.0" > VERSION
git add VERSION
git commit -m "üöÄ Bump version to 1.0.0"
git push origin main

# Op√ß√£o 2: Executar via GitHub Actions
# 1. V√° para Actions ‚Üí Release Pipeline
# 2. Clique em "Run workflow"
# 3. Preencha a vers√£o (ou deixe vazio para usar VERSION)
# 4. Clique em "Run workflow"
```

### **Rollback Manual**
```bash
# 1. V√° para Actions ‚Üí Rollback Pipeline
# 2. Clique em "Run workflow"
# 3. Preencha:
#    - Version: 1.0.0 (vers√£o para voltar)
#    - Confirm rollback: YES
# 4. Clique em "Run workflow"

# Ver vers√µes dispon√≠veis para rollback
curl -s "https://hub.docker.com/v2/repositories/1234samue/desafio-devops-api/tags/" | jq -r '.results[].name'
```

### **Verificar Status**
```bash
# Ver vers√£o atual
cat VERSION

# Ver logs do pipeline
# Acesse: https://github.com/seu-usuario/seu-repo/actions

# Conectar na VM
ssh -i terraform/keys/desafio-devops-key ubuntu@$(terraform output -raw elastic_ip)

# Ver vers√µes dispon√≠veis no Docker Hub
curl -s "https://hub.docker.com/v2/repositories/1234samue/desafio-devops-api/tags/" | jq -r '.results[].name'
```

### **Debug Local**
```bash
# Testar aplica√ß√£o local
cd backend
npm install
npm test
npm start

# Testar Terraform
cd terraform
terraform init
terraform plan
terraform apply

# Testar Docker
docker build -t desafio-devops-api:local .
docker run -p 3000:3000 desafio-devops-api:local
```

## üîß Personaliza√ß√£o

### **Alterar Nome da Imagem Docker**
Edite em `.github/workflows/release.yml`:
```yaml
env:
  DOCKER_IMAGE_NAME: seu-usuario/sua-imagem
```

### **Alterar Regi√£o AWS**
Edite em `.github/workflows/terraform.yml`:
```yaml
env:
  AWS_REGION: 'us-west-2'
```

### **Adicionar Mais Testes**
Adicione em `backend/tests/` e configure no `package.json`

### **Configurar DAST Scan**
Edite `backend/scripts/simple-dast.js` para adicionar novos testes de seguran√ßa

## üêõ Troubleshooting

### **Erro de SSH na VM**
```bash
# Verificar se a chave SSH est√° configurada
# Settings > Secrets > SSH_PRIVATE_KEY

# Testar conex√£o manual
ssh -i terraform/keys/desafio-devops-key ubuntu@$(terraform output -raw elastic_ip)
```

### **Erro de Autentica√ß√£o Docker Hub**
- Verifique se `DOCKERHUB_USERNAME` e `DOCKERHUB_TOKEN` est√£o configurados
- Confirme se o token tem permiss√µes de push

### **Erro de AWS Credentials**
- Verifique se `AWS_ACCESS_KEY_ID` e `AWS_SECRET_ACCESS_KEY` est√£o configurados
- Confirme se as credenciais t√™m permiss√µes adequadas

### **Falha nos Testes**
```bash
# Verificar se o PostgreSQL est√° rodando
# Confirme se as vari√°veis de ambiente est√£o corretas
npm run test:setup
```

### **Infraestrutura n√£o Aplicada**
```bash
cd terraform
terraform init
terraform plan
terraform apply
```

### **Release n√£o Executa**
- **Trigger Manual**: Execute via GitHub Actions ‚Üí Release Pipeline ‚Üí Run workflow
- **Vers√£o**: Preencha a vers√£o ou deixe vazio para usar arquivo `VERSION`
- **Permiss√µes**: Verifique se `GITHUB_TOKEN` tem permiss√µes de `contents: write`
- **Logs**: Verifique os logs do pipeline para detalhes

### **Deploy n√£o Executa**
- Verifique se ambos os workflows (Backend CI e Terraform) terminaram com sucesso
- Confirme se n√£o h√° outro deploy em andamento
- Verifique se a infraestrutura est√° aplicada via Terraform
- Confirme se as credenciais SSH est√£o configuradas

### **Rollback n√£o Executa**
- **Vers√£o**: Verifique se a vers√£o existe no Docker Hub
- **Confirma√ß√£o**: Digite "YES" no campo de confirma√ß√£o
- **Permiss√µes**: Verifique se as credenciais SSH est√£o configuradas
- **Logs**: Verifique os logs do pipeline para detalhes

## üìä Monitoramento

### **Status da Aplica√ß√£o**
- **Health Check**: http://$(terraform output -raw elastic_ip):3000/health
- **API**: http://$(terraform output -raw elastic_ip):3000/users
- **Logs**: Via SSH na VM

### **M√©tricas AWS**
- **CPU Utilization**: CloudWatch
- **Instance Status**: EC2 Console
- **Security Groups**: VPC Console

### **Pipeline Status**
- **GitHub Actions**: https://github.com/seu-usuario/seu-repo/actions
- **Docker Hub**: https://hub.docker.com/r/1234samue/desafio-devops-api
- **Releases**: https://github.com/seu-usuario/seu-repo/releases

## üìà Pr√≥ximos Passos

Para melhorar o pipeline, considere:

1. **Blue-Green Deploy** para zero downtime
2. **Testes de Performance** com Artillery ou k6
3. **An√°lise de C√≥digo** com SonarQube
4. **Notifica√ß√µes** via Slack/Discord/Teams
5. **Rollback Autom√°tico** em caso de falha
6. **Monitoramento Avan√ßado** com Prometheus/Grafana
7. **Logs Centralizados** com ELK Stack
8. **Testes de Integra√ß√£o** mais abrangentes
9. **Multi-Environment** (dev, staging, prod)
10. **Infrastructure as Code** mais robusto
11. **Canary Deployments** para testes graduais
12. **Feature Flags** para controle de funcionalidades

## üîó Links √öteis

- **GitHub Actions**: https://github.com/seu-usuario/seu-repo/actions
- **Docker Hub**: https://hub.docker.com/r/1234samue/desafio-devops-api
- **AWS Console**: https://console.aws.amazon.com
- **Terraform Docs**: https://www.terraform.io/docs
- **GitHub Secrets**: Settings > Secrets and variables > Actions

## üö® Cen√°rios de Uso

### **Deploy Normal**
1. Desenvolver funcionalidade
2. Fazer push para main
3. Executar Release Pipeline manualmente
4. Deploy autom√°tico via Deploy Pipeline

### **Rollback de Emerg√™ncia**
1. Identificar problema na vers√£o atual
2. Executar Rollback Pipeline
3. Especificar vers√£o est√°vel anterior
4. Confirmar rollback ("YES")
5. Aplica√ß√£o volta para vers√£o anterior

### **Debug e Troubleshooting**
1. Verificar logs dos pipelines
2. Testar conectividade SSH
3. Verificar status da aplica√ß√£o
4. Executar rollback se necess√°rio

---

**üéØ Pipeline completo configurado e funcionando!**

**Fluxo**: Desenvolvimento ‚Üí CI ‚Üí Release (Manual) ‚Üí Deploy ‚Üí Monitoramento ‚Üí Rollback (se necess√°rio)

**üõ°Ô∏è Seguran√ßa**: Valida√ß√µes, confirma√ß√µes e testes em todos os pipelines 