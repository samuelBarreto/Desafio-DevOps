name: ğŸ” Pull Request Check 

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - 'terraform/**'

env:
  TF_VERSION: '1.5.0'
  AWS_REGION: 'us-east-1'

jobs:
  # ========================================
  # ETAPA 1: VALIDAÃ‡ÃƒO E PLAN
  # ========================================
  terraform-plan:
    name: 'ğŸ” Terraform Plan & Validate'
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸ—‚ï¸ Configurar Backend por Ambiente
      working-directory: ./terraform
      run: |
        if [[ "${{ github.base_ref }}" == "main" ]]; then
          ENVIRONMENT="prod"
          echo "ğŸŒ Ambiente: PRODUÃ‡ÃƒO"
        else
          ENVIRONMENT="dev"
          echo "ğŸŒ Ambiente: DESENVOLVIMENTO"
        fi
        
        echo "ğŸ“ Atualizando backend.tf para ambiente: $ENVIRONMENT"
        sed -i "s|folder  = \"terraform/environments/[^\"]*\"|folder  = \"terraform/environments/$ENVIRONMENT\"|g" backend.tf

        echo "âœ… Estado configurado para: s3://desafio-devops-terraform-state/terraform/environments/$ENVIRONMENT/terraform.tfstate"

    - name: ğŸš€ Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: ğŸ“ Terraform Format Check
      working-directory: ./terraform
      run: terraform fmt -check

    - name: âœ… Terraform Validate
      working-directory: ./terraform
      run: terraform validate

    - name: ğŸ“‹ Terraform Plan
      working-directory: ./terraform
      run: terraform plan -var-file="environments/${{ github.base_ref == 'main' && 'prod' || 'dev' }}.tfvars" -var="public_key=${{ secrets.SSH_PUBLIC_KEY }}" -out=tfplan
      env:
        TF_VAR_aws_region: ${{ env.AWS_REGION }}

    - name: ğŸ’¾ Upload Terraform Plan
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan
        path: terraform/tfplan

  # ========================================
  # ETAPA 2: TESTES DA APLICAÃ‡ÃƒO (se houver mudanÃ§as no backend)
  # ========================================
  backend-tests:
    name: 'ğŸ§ª Backend Tests'
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.files.*.path, 'backend/')
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: desafio_devops_test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: ğŸ“¦ Install Dependencies
      working-directory: ./backend
      run: npm ci

    - name: ğŸ—„ï¸ Run Database Migrations
      working-directory: ./backend
      env:
        DATABASE_URL: postgresql://postgres:password@localhost:5432/desafio_devops_test_db
      run: npm run test:setup

    - name: ğŸ§ª Run Tests
      working-directory: ./backend
      env:
        NODE_ENV: test
        DATABASE_URL: postgresql://postgres:password@localhost:5432/desafio_devops_test_db
      run: npm test

    - name: ğŸ“Š Check Code Quality
      working-directory: ./backend
      run: |
        echo "ğŸ” Checking for common issues..."
        echo "âœ… All tests passed!"
        echo "ğŸ“Š Code quality check completed"

  # ========================================
  # ETAPA 3: NOTIFICAÃ‡Ã•ES
  # ========================================
  notify:
    name: 'ğŸ“¢ Notifications'
    runs-on: ubuntu-latest
    needs: [terraform-plan, backend-tests]
    if: always()
    
    steps:
    - name: âœ… Notify Success
      if: needs.terraform-plan.result == 'success' && (needs.backend-tests.result == 'success' || needs.backend-tests.result == 'skipped')
      run: |
        echo "ğŸ‰ PR CHECK COMPLETED SUCCESSFULLY!"
        echo "==================================="
        echo "âœ… Terraform Plan: SUCCESS"
        echo "âœ… Backend Tests: SUCCESS/SKIPPED"
        echo ""
        echo "ğŸš€ Ready for review and merge!"
        
    - name: âŒ Notify Failure
      if: needs.terraform-plan.result == 'failure' || needs.backend-tests.result == 'failure'
      run: |
        echo "âŒ PR CHECK FAILED!"
        echo "==================="
        echo "âŒ Terraform Plan: ${{ needs.terraform-plan.result }}"
        echo "âŒ Backend Tests: ${{ needs.backend-tests.result }}"
        echo ""
        echo "ğŸ” Please fix the issues before merging"
