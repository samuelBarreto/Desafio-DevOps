name: ğŸ”„ Rollback Pipeline

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to rollback to (e.g., 1.0.0)'
        required: true
        type: string
      confirm_rollback:
        description: 'Confirm rollback (type YES to confirm)'
        required: true
        type: string
        default: 'NO'

env:
  DOCKER_IMAGE_NAME: 1234samue/desafio-devops-api
  AWS_REGION: 'us-east-1'

permissions:
  contents: read

jobs:
  # ========================================
  # ETAPA 1: VALIDAR ROLLBACK
  # ========================================
  validate-rollback:
    name: 'ğŸ” Validate Rollback'
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Validate Inputs
      run: |
        echo "ğŸ” Validando inputs do rollback..."
        
        VERSION="${{ github.event.inputs.version }}"
        CONFIRM="${{ github.event.inputs.confirm_rollback }}"
        
        echo "ğŸ“‹ Version to rollback: $VERSION"
        echo "ğŸ“‹ Confirmation: $CONFIRM"
        
        # Validar formato da versÃ£o
        if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âŒ Invalid version format. Expected: X.Y.Z (e.g., 1.0.0)"
          exit 1
        fi
        
        # Validar confirmaÃ§Ã£o
        if [ "$CONFIRM" != "YES" ]; then
          echo "âŒ Rollback not confirmed. Type 'YES' to confirm."
          exit 1
        fi
        
        echo "âœ… Rollback validation passed"
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: ğŸ” Check Version Exists
      run: |
        echo "ğŸ” Verificando se a versÃ£o existe no Docker Hub..."
        
        VERSION="${{ github.event.inputs.version }}"
        
        # Verificar se a imagem existe no Docker Hub
        if ! curl -f "https://hub.docker.com/v2/repositories/${{ env.DOCKER_IMAGE_NAME }}/tags/$VERSION/" > /dev/null 2>&1; then
          echo "âŒ Version $VERSION not found in Docker Hub!"
          echo "ğŸ’¡ Available versions:"
          curl -s "https://hub.docker.com/v2/repositories/${{ env.DOCKER_IMAGE_NAME }}/tags/" | jq -r '.results[].name' | head -10
          exit 1
        fi
        
        echo "âœ… Version $VERSION found in Docker Hub"

  # ========================================
  # ETAPA 2: ROLLBACK NA VM
  # ========================================
  rollback-vm:
    name: 'ğŸ”„ Rollback VM'
    runs-on: ubuntu-latest
    needs: validate-rollback
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.5.0'

    - name: ğŸš€ Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: ğŸ“Š Get Instance IP
      working-directory: ./terraform
      id: infra
      run: |
        echo "ğŸ” Obtendo IP da instÃ¢ncia..."
        INSTANCE_IP=$(terraform output -raw instance_public_ip 2>/dev/null) || {
          echo "âŒ ERRO: NÃ£o foi possÃ­vel obter o IP da instÃ¢ncia!"
          exit 1
        }
        echo "âœ… IP da instÃ¢ncia obtido: $INSTANCE_IP"
        echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT

    - name: ğŸ” Setup SSH Connection
      run: |
        echo "ğŸ” Configurando SSH..."
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ steps.infra.outputs.instance_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true
        echo "âœ… SSH configurado"

    - name: ğŸ”„ Execute Rollback
      run: |
        echo "ğŸ”„ Executando rollback para versÃ£o ${{ github.event.inputs.version }}..."
        
        ssh ubuntu@${{ steps.infra.outputs.instance_ip }} << 'EOF'
          echo "ğŸ“ Navegando para diretÃ³rio da aplicaÃ§Ã£o..."
          cd /opt/app/desafio-devops/backend
          
          echo "ğŸ“ Atualizando docker-compose.prod.yml com versÃ£o de rollback..."
          
          # Backup do arquivo atual
          cp docker-compose.prod.yml docker-compose.prod.yml.backup.$(date +%Y%m%d_%H%M%S)
          
          # Atualizar a imagem com a versÃ£o de rollback
          sed -i "s|image:.*1234samue/desafio-devops-api:.*|image: \${DOCKER_IMAGE_NAME:-1234samue/desafio-devops-api}:${{ github.event.inputs.version }}|g" docker-compose.prod.yml
          
          echo "âœ… docker-compose.prod.yml atualizado com versÃ£o ${{ github.event.inputs.version }}"
          
          echo "ğŸ”„ Parando containers existentes..."
          docker compose -f docker-compose.prod.yml down || true
          
          echo "ğŸ“¥ Baixando imagem de rollback..."
          docker pull ${{ env.DOCKER_IMAGE_NAME }}:${{ github.event.inputs.version }}
          
          echo "ğŸš€ Iniciando aplicaÃ§Ã£o com versÃ£o de rollback..."
          docker compose -f docker-compose.prod.yml up -d
          
          echo "â³ Aguardando aplicaÃ§Ã£o inicializar..."
          sleep 30
          
          echo "ğŸ” Verificando status dos containers..."
          docker compose -f docker-compose.prod.yml ps
          
          echo "ğŸ“Š Verificando logs da aplicaÃ§Ã£o..."
          docker compose -f docker-compose.prod.yml logs --tail=20
        EOF

  # ========================================
  # ETAPA 3: TESTES PÃ“S-ROLLBACK
  # ========================================
  post-rollback-tests:
    name: 'ğŸ§ª Post-Rollback Tests'
    runs-on: ubuntu-latest
    needs: rollback-vm
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.5.0'

    - name: ğŸš€ Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: ğŸ“Š Get Instance IP
      working-directory: ./terraform
      id: infra
      run: |
        echo "instance_ip=$(terraform output -raw instance_public_ip)" >> $GITHUB_OUTPUT

    - name: ğŸ” Health Check
      run: |
        echo "ğŸ” Verificando health check apÃ³s rollback..."
        
        # Aguardar aplicaÃ§Ã£o estar pronta
        for i in {1..30}; do
          echo "â³ Tentativa $i/30 - Verificando health check..."
          if curl -f http://${{ steps.infra.outputs.instance_ip }}:3000/health > /dev/null 2>&1; then
            echo "âœ… Health check passou!"
            break
          fi
          sleep 10
        done
        
        # Teste final
        if ! curl -f http://${{ steps.infra.outputs.instance_ip }}:3000/health; then
          echo "âŒ Health check falhou apÃ³s rollback"
          exit 1
        fi

    - name: ğŸ§ª API Tests
      run: |
        echo "ğŸ§ª Executando testes da API apÃ³s rollback..."
        
        # Teste de health check
        echo "ğŸ’š Testando health check..."
        curl -X GET http://${{ steps.infra.outputs.instance_ip }}:3000/health \
          -w "\nStatus: %{http_code}\n"
        
        # Teste de listagem de usuÃ¡rios
        echo "ğŸ“‹ Testando listagem de usuÃ¡rios..."
        curl -X GET http://${{ steps.infra.outputs.instance_ip }}:3000/users \
          -w "\nStatus: %{http_code}\n"

  # ========================================
  # ETAPA 4: NOTIFICAÃ‡ÃƒO
  # ========================================
  notification:
    name: 'ğŸ“¢ Rollback Notification'
    runs-on: ubuntu-latest
    needs: [rollback-vm, post-rollback-tests]
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.5.0'

    - name: ğŸš€ Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: ğŸ“Š Get Instance IP
      working-directory: ./terraform
      id: infra
      run: |
        echo "instance_ip=$(terraform output -raw instance_public_ip)" >> $GITHUB_OUTPUT

    - name: ğŸ“‹ Rollback Summary
      run: |
        echo "ğŸ”„ ROLLBACK SUMMARY"
        echo "==================="
        echo "âœ… Rollback to version: ${{ github.event.inputs.version }}"
        echo "ğŸŒ Public URL: http://${{ steps.infra.outputs.instance_ip }}:3000"
        echo "ğŸ³ Docker Image: ${{ env.DOCKER_IMAGE_NAME }}:${{ github.event.inputs.version }}"
        echo "ğŸ“… Rollback at: $(date)"
        echo "ğŸ”— Health Check: http://${{ steps.infra.outputs.instance_ip }}:3000/health"

    - name: ğŸ“¢ Success Notification
      if: success()
      run: |
        echo "ğŸ”„ ROLLBACK SUCCESSFUL!"
        echo "======================="
        echo "âœ… Rollback completed successfully"
        echo "âœ… Application is running with version ${{ github.event.inputs.version }}"
        echo "âœ… All tests passed"
        echo "ğŸŒ Access your application at: http://${{ steps.infra.outputs.instance_ip }}:3000"

    - name: ğŸš¨ Failure Notification
      if: failure()
      run: |
        echo "âŒ ROLLBACK FAILED!"
        echo "==================="
        echo "âŒ Rollback to version ${{ github.event.inputs.version }} failed"
        echo "ğŸ” Check the logs above for details"
        echo "ğŸ”„ Manual intervention may be required" 