name: ðŸš€ Release Pipeline

on:
  workflow_dispatch:
 
    inputs:
      version:
        description: 'Version to release (leave empty to use VERSION file)'
        required: false
        type: string

env:
  DOCKER_IMAGE_NAME: 1234samue/desafio-devops-api
  AWS_REGION: 'us-east-1'

permissions:
  contents: write
  packages: write

jobs:
  # ========================================
  # ETAPA 1: VALIDAR E LER VERSÃƒO
  # ========================================
  validate-version:
    name: 'ðŸ” Validate Version'
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      version-tag: ${{ steps.get-version.outputs.version-tag }}
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ” Read Version from File
      id: get-version
      run: |
        # Ler versÃ£o do arquivo VERSION ou usar input manual
        if [ -n "${{ github.event.inputs.version }}" ]; then
          VERSION="${{ github.event.inputs.version }}"
          echo "ðŸ“‹ Using manual version: $VERSION"
        else
          VERSION=$(cat VERSION | tr -d ' \t\n\r')
          echo "ðŸ“‹ Using version from file: $VERSION"
        fi
        
        # Validar formato da versÃ£o (semver)
        if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âŒ Invalid version format. Expected: X.Y.Z (e.g., 1.0.0)"
          exit 1
        fi
        
        # Criar tag da versÃ£o
        VERSION_TAG="v$VERSION"
        
        echo "âœ… Version validated: $VERSION"
        echo "ðŸ·ï¸ Version tag: $VERSION_TAG"
        
        # Set outputs
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version-tag=$VERSION_TAG" >> $GITHUB_OUTPUT

    - name: ðŸ“‹ Display Version Info
      run: |
        echo "ðŸŽ¯ RELEASE INFO"
        echo "==============="
        echo "Version: ${{ steps.get-version.outputs.version }}"
        echo "Version Tag: ${{ steps.get-version.outputs.version-tag }}"
        echo "Docker Image: ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.get-version.outputs.version }}"

  # ========================================
  # ETAPA 2: BUILD E PUSH DA IMAGEM
  # ========================================
  build-and-push:
    name: 'ðŸ³ Build and Push Docker Image'
    runs-on: ubuntu-latest
    needs: validate-version
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ—ï¸ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ”Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: ðŸ“¦ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.DOCKER_IMAGE_NAME }}
        tags: |
          type=raw,value=${{ needs.validate-version.outputs.version }}
          type=raw,value=${{ needs.validate-version.outputs.version-tag }}
          type=raw,value=latest
          type=sha

    - name: ðŸ“¦ Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VERSION=${{ needs.validate-version.outputs.version }}

    - name: ðŸ“‹ Display Image Info
      run: |
        echo "ðŸ³ DOCKER IMAGE INFO"
        echo "==================="
        echo "Image: ${{ env.DOCKER_IMAGE_NAME }}"
        echo "Version: ${{ needs.validate-version.outputs.version }}"
        echo "Tags: ${{ steps.meta.outputs.tags }}"
        echo "Pushed successfully! ðŸš€"

  # ========================================
  # ETAPA 3: ATUALIZAR IMAGEM NA VM
  # ========================================
  update-vm-image:
    name: 'ðŸ–¥ï¸ Update Image in VM'
    runs-on: ubuntu-latest
    needs: [validate-version, build-and-push]
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ðŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.5.0'

    - name: ðŸš€ Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: ðŸ“Š Get Instance IP from Terraform
      working-directory: ./terraform
      id: infra
      run: |
        echo "ðŸ” Obtendo IP da instÃ¢ncia via Terraform..."
        
        # Fazer plan para verificar o estado atual
        echo "ðŸ“‹ Executando terraform plan..."
        terraform plan -out=tfplan || {
          echo "âŒ ERRO: Falha no terraform plan!"
          exit 1
        }
        
        # Obter o IP da instÃ¢ncia
        INSTANCE_IP=$(terraform output -raw instance_public_ip 2>/dev/null) || {
          echo "âŒ ERRO: NÃ£o foi possÃ­vel obter o IP da instÃ¢ncia!"
          echo "ðŸ’¡ Verificando se a infraestrutura estÃ¡ aplicada..."
          terraform show || echo "âŒ Terraform state nÃ£o encontrado"
          exit 1
        }
        
        # Validar se o IP nÃ£o estÃ¡ vazio
        if [ -z "$INSTANCE_IP" ]; then
          echo "âŒ ERRO: IP da instÃ¢ncia estÃ¡ vazio!"
          exit 1
        fi
        
        # Validar formato do IP
        if ! echo "$INSTANCE_IP" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' > /dev/null; then
          echo "âŒ ERRO: Formato de IP invÃ¡lido: $INSTANCE_IP"
          exit 1
        fi
        
        echo "âœ… IP da instÃ¢ncia obtido via Terraform: $INSTANCE_IP"
        echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT

    - name: ðŸ” Setup SSH Connection
      run: |
        echo "ðŸ” Configurando SSH..."
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 3.219.24.200 >> ~/.ssh/known_hosts 2>/dev/null || true
        echo "âœ… SSH configurado"

    - name: ðŸ”„ Update Image in VM
      run: |
        echo "ðŸ”„ Atualizando imagem na VM..."
        
        ssh ubuntu@3.219.24.200 << 'EOF'
          echo "ðŸ“ Navegando para diretÃ³rio da aplicaÃ§Ã£o..."
          cd /opt/app/desafio-devops/backend
          
          echo "ðŸ“ Atualizando docker-compose.prod.yml com nova versÃ£o..."
          
          # Backup do arquivo original
          cp docker-compose.prod.yml docker-compose.prod.yml.backup
          
          # Atualizar a imagem com a nova versÃ£o
          sed -i "s|image:.*1234samue/desafio-devops-api:.*|image: \${DOCKER_IMAGE_NAME:-1234samue/desafio-devops-api}:${{ needs.validate-version.outputs.version }}|g" docker-compose.prod.yml
          
          echo "âœ… docker-compose.prod.yml atualizado com versÃ£o ${{ needs.validate-version.outputs.version }}"
          
          echo "ðŸ”„ Parando containers existentes..."
          docker compose -f docker-compose.prod.yml down || true
          
          echo "ðŸ“¥ Baixando nova imagem..."
          docker pull ${{ env.DOCKER_IMAGE_NAME }}:${{ needs.validate-version.outputs.version }}
          
          echo "ðŸš€ Iniciando aplicaÃ§Ã£o com nova versÃ£o..."
          docker compose -f docker-compose.prod.yml up -d
          
          echo "â³ Aguardando aplicaÃ§Ã£o inicializar..."
          sleep 30
          
          echo "ðŸ” Verificando status dos containers..."
          docker compose -f docker-compose.prod.yml ps
          
          echo "ðŸ“Š Verificando logs da aplicaÃ§Ã£o..."
          docker compose -f docker-compose.prod.yml logs --tail=20
        EOF

  # ========================================
  # ETAPA 4: CRIAR GIT TAG E RELEASE
  # ========================================
  create-release:
    name: 'ðŸ·ï¸ Create Git Tag and Release'
    runs-on: ubuntu-latest
    needs: [validate-version, build-and-push, update-vm-image]
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ” Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: ðŸ·ï¸ Create Git Tag
      run: |
        echo "ðŸ·ï¸ Creating git tag: ${{ needs.validate-version.outputs.version-tag }}"
        git tag -a "${{ needs.validate-version.outputs.version-tag }}" -m "Release version ${{ needs.validate-version.outputs.version }}"
        echo "âœ… Git tag created locally"

    - name: ðŸš€ Push Git Tag
      run: |
        echo "ðŸš€ Pushing git tag to remote..."
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
        git push origin "${{ needs.validate-version.outputs.version-tag }}"
        echo "âœ… Git tag pushed successfully"

    - name: ðŸ“‹ Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ needs.validate-version.outputs.version-tag }}
        release_name: Release ${{ needs.validate-version.outputs.version }}
        body: |
          ðŸš€ Release Version ${{ needs.validate-version.outputs.version }}
          
          ## ðŸ“¦ Docker Image
          - **Image**: `${{ env.DOCKER_IMAGE_NAME }}:${{ needs.validate-version.outputs.version }}`
          - **Tag**: `${{ needs.validate-version.outputs.version-tag }}`
          
          ## ðŸš€ Deploy
          - âœ… Docker image built and pushed
          - âœ… VM updated with new image
          - âœ… Application deployed successfully
          
          ## ðŸ“Š API Endpoints
          - Health Check: `/health`
          - Users: `/users`
          
          ## ðŸ”— Links
          - Docker Hub: https://hub.docker.com/r/${{ env.DOCKER_IMAGE_NAME }}
        draft: false
        prerelease: false

    - name: ðŸ“‹ Display Release Summary
      run: |
        echo "ðŸŽ‰ RELEASE SUMMARY"
        echo "=================="
        echo "âœ… Version: ${{ needs.validate-version.outputs.version }}"
        echo "âœ… Tag: ${{ needs.validate-version.outputs.version-tag }}"
        echo "âœ… Docker Image: ${{ env.DOCKER_IMAGE_NAME }}:${{ needs.validate-version.outputs.version }}"
        echo "âœ… VM updated with new image"
        echo "âœ… Git tag created"
        echo "âœ… GitHub release created"
        echo ""
        echo "ðŸŽ¯ Release completed successfully!" 