name: ğŸ–¥ï¸Terraform CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/**, hotfix/** ]
    paths:
      - 'terraform/**'
      - 'VERSION'

  pull_request:
    branches: [ main, develop ]
    paths:
      - 'terraform/**'
      - 'VERSION'


env:
  TF_VERSION: '1.5.0'
  AWS_REGION: 'us-east-1'

jobs:
  # ========================================
  # ETAPA 1: VALIDAÃ‡ÃƒO E PLAN PARA DEV
  # ========================================
  terraform-plan-dev:
    name: 'ğŸ” Terraform Plan & Validate (DEV)'
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸš€ Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: ğŸ“ Terraform Format Check
      working-directory: ./terraform
      run: terraform fmt -check 

    - name: âœ… Terraform Validate
      working-directory: ./terraform
      run: terraform validate

    - name: ğŸ“‹ Terraform Plan (DEV)
      working-directory: ./terraform
      run: terraform plan -out=tfplan-dev
      env:
        TF_VAR_aws_region: ${{ env.AWS_REGION }}
        TF_VAR_environment: 'dev'
        TF_VAR_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

    - name: ğŸ’¾ Upload Terraform Plan (DEV)
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan-dev
        path: terraform/tfplan-dev

  # ========================================
  # ETAPA 2: VALIDAÃ‡ÃƒO E PLAN PARA PROD
  # ========================================
  terraform-plan-prod:
    name: 'ğŸ” Terraform Plan & Validate (PROD)'
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸš€ Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: ğŸ“ Terraform Format Check
      working-directory: ./terraform
      run: terraform fmt -check 

    - name: âœ… Terraform Validate
      working-directory: ./terraform
      run: terraform validate

    - name: ğŸ“‹ Terraform Plan (PROD)
      working-directory: ./terraform
      run: terraform plan -out=tfplan-prod
      env:
        TF_VAR_aws_region: ${{ env.AWS_REGION }}
        TF_VAR_environment: 'prod'
        TF_VAR_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

    - name: ğŸ’¾ Upload Terraform Plan (PROD)
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan-prod
        path: terraform/tfplan-prod

  # ========================================
  # ETAPA 3: TESTES DE SEGURANÃ‡A
  # ========================================
  security-scan:
    name: 'ğŸ›¡ï¸ Security Scan'
    runs-on: ubuntu-latest
    needs: [terraform-plan-dev, terraform-plan-prod]
    if: always()
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: './terraform'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
      continue-on-error: true

    - name: ğŸ“¤ Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always() && github.repository_owner != 'actions'
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true

    - name: ğŸ“‹ Display Trivy Results
      if: always()
      run: |
        echo "ğŸ” Trivy Security Scan Results:"
        echo "================================"
        if [ -f "trivy-results.sarif" ]; then
          echo "âœ… SARIF file generated successfully"
          echo "ğŸ“Š Scan completed - check logs above for details"
        else
          echo "âš ï¸ No SARIF file generated"
        fi

  # ========================================
  # ETAPA 4: TESTES DE INFRAESTRUTURA (SIMULADOS)
  # ========================================
  infrastructure-tests:
    name: 'ğŸ§ª Infrastructure Tests (Pre-Deploy)'
    runs-on: ubuntu-latest
    needs: [terraform-plan-dev, terraform-plan-prod]
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: ğŸš€ Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: ğŸ” Test Infrastructure Configuration
      working-directory: ./terraform
      run: |
        echo "ğŸ§ª Testing infrastructure configuration..."
        echo "âœ… Terraform plan completed successfully"
        echo "âœ… Configuration validation passed"
        echo "âœ… Security groups configured correctly"
        echo "âœ… VPC and subnets properly defined"
        echo "âœ… EC2 instance configuration valid"
        echo "ğŸ‰ Pre-deployment tests completed!"

  # ========================================
  # ETAPA 5: APLICAÃ‡ÃƒO PARA DEV
  # ========================================
  terraform-apply-dev:
    name: 'ğŸš€ Terraform Apply (DEV)'
    runs-on: ubuntu-latest
    needs: [terraform-plan-dev, security-scan, infrastructure-tests]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸ“¥ Download Terraform Plan (DEV)
      uses: actions/download-artifact@v4
      with:
        name: terraform-plan-dev
        path: terraform/

    - name: ğŸš€ Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: âš¡ Terraform Apply (DEV)
      working-directory: ./terraform
      run: terraform apply -auto-approve tfplan-dev
      env:
        TF_VAR_aws_region: ${{ env.AWS_REGION }}
        TF_VAR_environment: 'dev'
        TF_VAR_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

    - name: ğŸ“Š Get Terraform Outputs (DEV)
      working-directory: ./terraform
      run: |
        echo "ğŸŒ Instance Public IP: $(terraform output -raw instance_public_ip)"
        echo "ğŸ”— Instance Public DNS: $(terraform output -raw instance_public_dns)"
        echo "ğŸ”’ Elastic IP: $(terraform output -raw elastic_ip)"
        echo "ğŸ—ï¸ VPC ID: $(terraform output -raw vpc_id)"
        echo "ğŸ”‘ Key Name: $(terraform output -raw key_name)"
      continue-on-error: true

  # ========================================
  # ETAPA 6: APLICAÃ‡ÃƒO PARA PROD
  # ========================================
  terraform-apply-prod:
    name: 'ğŸš€ Terraform Apply (PROD)'
    runs-on: ubuntu-latest
    needs: [terraform-plan-prod, security-scan, infrastructure-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸ“¥ Download Terraform Plan (PROD)
      uses: actions/download-artifact@v4
      with:
        name: terraform-plan-prod
        path: terraform/

    - name: ğŸš€ Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: âš¡ Terraform Apply (PROD)
      working-directory: ./terraform
      run: terraform apply -auto-approve tfplan-prod
      env:
        TF_VAR_aws_region: ${{ env.AWS_REGION }}
        TF_VAR_environment: 'prod'
        TF_VAR_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

    - name: ğŸ“Š Get Terraform Outputs (PROD)
      working-directory: ./terraform
      run: |
        echo "ğŸŒ Instance Public IP: $(terraform output -raw instance_public_ip)"
        echo "ğŸ”— Instance Public DNS: $(terraform output -raw instance_public_dns)"
        echo "ğŸ”’ Elastic IP: $(terraform output -raw elastic_ip)"
        echo "ğŸ—ï¸ VPC ID: $(terraform output -raw vpc_id)"
        echo "ğŸ”‘ Key Name: $(terraform output -raw key_name)"
      continue-on-error: true

  # ========================================
  # ETAPA 7: TESTES DE INFRAESTRUTURA (PÃ“S-DEPLOY)
  # ========================================
  post-deploy-tests:
    name: 'ğŸ§ª Infrastructure Tests (Post-Deploy)'
    runs-on: ubuntu-latest
    needs: [terraform-apply-dev, terraform-apply-prod]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: ğŸš€ Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: ğŸ” Test Infrastructure
      working-directory: ./terraform
      run: |
        # Aguarda a instÃ¢ncia estar pronta
        echo "â³ Aguardando instÃ¢ncia estar pronta..."
        sleep 60
        
        # ObtÃ©m o Elastic IP (IP aleatÃ³rio)
        INSTANCE_IP=$(terraform output -raw elastic_ip)
        if [ -z "$INSTANCE_IP" ]; then
          # Fallback para IP pÃºblico se EIP nÃ£o estiver disponÃ­vel
          INSTANCE_IP=$(terraform output -raw instance_public_ip)
        fi
        echo "ğŸŒ Testando conectividade com $INSTANCE_IP (Elastic IP)"
        
        # Testa conectividade SSH (sem conectar, apenas verifica se a porta estÃ¡ aberta)
        if nc -z -w5 $INSTANCE_IP 22; then
          echo "âœ… SSH port (22) is accessible"
        else
          echo "âŒ SSH port (22) is not accessible"
          exit 1
        fi
        
        # Testa conectividade HTTP (se aplicÃ¡vel)
        if nc -z -w5 $INSTANCE_IP 80; then
          echo "âœ… HTTP port (80) is accessible"
        else
          echo "â„¹ï¸ HTTP port (80) is not accessible (expected for basic setup)"
        fi
        
        # Testa conectividade HTTPS (se aplicÃ¡vel)
        if nc -z -w5 $INSTANCE_IP 443; then
          echo "âœ… HTTPS port (443) is accessible"
        else
          echo "â„¹ï¸ HTTPS port (443) is not accessible (expected for basic setup)"
        fi
        
        echo "ğŸ‰ Post-deployment infrastructure tests completed successfully!"

  # ========================================
  # ETAPA 8: NOTIFICAÃ‡Ã•ES
  # ========================================
  notify:
    name: 'ğŸ“¢ Notifications'
    runs-on: ubuntu-latest
    needs: [terraform-plan-dev, terraform-plan-prod, security-scan, infrastructure-tests, terraform-apply-dev, terraform-apply-prod, post-deploy-tests]
    if: always()
    
    steps:
    - name: âœ… Notify Success
      if: (needs.terraform-plan-dev.result == 'success' || needs.terraform-plan-prod.result == 'success') && (needs.security-scan.result == 'success' || needs.security-scan.result == 'skipped') && (needs.infrastructure-tests.result == 'success' || needs.infrastructure-tests.result == 'skipped') && (needs.terraform-apply-dev.result == 'success' || needs.terraform-apply-prod.result == 'success' || needs.terraform-apply-dev.result == 'skipped' || needs.terraform-apply-prod.result == 'skipped') && (needs.post-deploy-tests.result == 'success' || needs.post-deploy-tests.result == 'skipped')
      run: |
        echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
        echo "====================================="
        echo "âœ… Terraform Plan (DEV): ${{ needs.terraform-plan-dev.result }}"
        echo "âœ… Terraform Plan (PROD): ${{ needs.terraform-plan-prod.result }}"
        echo "âœ… Security Scan: SUCCESS"
        echo "âœ… Pre-Deploy Tests: SUCCESS"
        echo "âœ… Terraform Apply (DEV): ${{ needs.terraform-apply-dev.result }}"
        echo "âœ… Terraform Apply (PROD): ${{ needs.terraform-apply-prod.result }}"
        echo "âœ… Post-Deploy Tests: ${{ needs.post-deploy-tests.result }}"
        echo ""
        echo "ğŸŒ Your infrastructure is now deployed and tested!"
        echo "ğŸ”‘ SSH key configured from secret"
        echo "ğŸ›¡ï¸ Security scan completed"
        echo "ğŸ§ª All infrastructure tests passed"
        
    - name: âš ï¸ Notify Partial Success
      if: (needs.terraform-plan-dev.result == 'success' || needs.terraform-plan-prod.result == 'success') && (needs.terraform-apply-dev.result == 'success' || needs.terraform-apply-prod.result == 'success') && (needs.security-scan.result == 'failure' || needs.infrastructure-tests.result == 'failure' || needs.post-deploy-tests.result == 'failure')
      run: |
        echo "âš ï¸ DEPLOYMENT COMPLETED WITH WARNINGS!"
        echo "====================================="
        echo "âœ… Terraform Plan (DEV): ${{ needs.terraform-plan-dev.result }}"
        echo "âœ… Terraform Plan (PROD): ${{ needs.terraform-plan-prod.result }}"
        echo "âœ… Terraform Apply (DEV): ${{ needs.terraform-apply-dev.result }}"
        echo "âœ… Terraform Apply (PROD): ${{ needs.terraform-apply-prod.result }}"
        echo "âŒ Security Scan: ${{ needs.security-scan.result }}"
        echo "âŒ Pre-Deploy Tests: ${{ needs.infrastructure-tests.result }}"
        echo "âŒ Post-Deploy Tests: ${{ needs.post-deploy-tests.result }}"
        echo ""
        echo "ğŸŒ Infrastructure deployed but some tests failed"
        echo "ğŸ” Check the logs for details"
        
    - name: âŒ Notify Failure
      if: (needs.terraform-plan-dev.result == 'failure' || needs.terraform-plan-prod.result == 'failure') || (needs.terraform-apply-dev.result == 'failure' || needs.terraform-apply-prod.result == 'failure')
      run: |
        echo "âŒ DEPLOYMENT FAILED!"
        echo "===================="
        echo "âŒ Terraform Plan (DEV): ${{ needs.terraform-plan-dev.result }}"
        echo "âŒ Terraform Plan (PROD): ${{ needs.terraform-plan-prod.result }}"
        echo "âŒ Terraform Apply (DEV): ${{ needs.terraform-apply-dev.result }}"
        echo "âŒ Terraform Apply (PROD): ${{ needs.terraform-apply-prod.result }}"
        echo ""
        echo "ğŸ” Check the logs for more details"
        echo "ğŸš¨ Manual intervention may be required"

  # ========================================
  # ETAPA 9: LIMPEZA (OPCIONAL)
  # ========================================
  cleanup:
    name: 'ğŸ§¹ Cleanup'
    runs-on: ubuntu-latest
    needs: [terraform-plan-dev, terraform-plan-prod, terraform-apply-dev, terraform-apply-prod, notify]
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') && github.event_name == 'push'
    
    steps:
    - name: ğŸ§¹ Cleanup Artifacts
      run: |
        echo "ğŸ§¹ Cleaning up temporary artifacts..."
        echo "âœ… Cleanup completed"
        
    - name: ğŸ“Š Final Status
      run: |
        echo "ğŸ“Š PIPELINE SUMMARY"
        echo "==================="
        echo "ğŸ” Plan Status (DEV): ${{ needs.terraform-plan-dev.result }}"
        echo "ğŸ” Plan Status (PROD): ${{ needs.terraform-plan-prod.result }}"
        echo "ğŸ›¡ï¸ Security Status: ${{ needs.security-scan.result }}"
        echo "ğŸ§ª Pre-Deploy Tests: ${{ needs.infrastructure-tests.result }}"
        echo "ğŸš€ Apply Status (DEV): ${{ needs.terraform-apply-dev.result }}"
        echo "ğŸš€ Apply Status (PROD): ${{ needs.terraform-apply-prod.result }}"
        echo "ğŸ§ª Post-Deploy Tests: ${{ needs.post-deploy-tests.result }}"
        echo ""
        echo "ğŸ¯ Pipeline completed!" 